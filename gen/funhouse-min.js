(function(){var n,ja,U,P,V,z,t,W,X,Y,ka,G,Z,la,ma,$,aa,E,ba,L,F,na,ca,da,H,q,I,K,C,ea,Q,fa,R,r,ga,oa,ha,h,D,S,pa,qa,ra,sa,ta,ua,va,wa,M,xa,T,J,y,O,ya,N,ia=[].slice,za={}.hasOwnProperty,x=function(b,a){function g(){this.constructor=b}for(var c in a)za.call(a,c)&&(b[c]=a[c]);g.prototype=a.prototype;b.prototype=new g;b.__super__=a.prototype;return b};if(null==(t=String.prototype).trim)t.trim=function(){return String(this).replace(/^\s+|\s+$/g,"")};null==Math.sign&&(Math.sign=function(b){return 0<b?1:
0>b?-1:0});if(null==(t=Array.prototype).removeRandom)t.removeRandom=function(){return this.splice(Math.floor(ROT.RNG.getUniform()*this.length),1)[0]};if(null==(t=Array.prototype).remove)t.remove=function(b){for(var a;-1!==(a=this.indexOf(b));)this.splice(a,1)};window.assert=void 0!==console&&void 0!==console.assert?console.assert.bind(console):function(b,a){if(!b)throw a;};L=function(){function b(){}b.distance=function(a,g){var c,b;c=g[0]-a[0];b=g[1]-a[1];return Math.sqrt(c*c+b*b)};return b}();assert(1===
L.distance([0,0],[1,0]));assert(5===L.distance([0,0],[3,4]));window.Point=L;F=function(){function b(a,g,c,b){this.x1=a;this.y1=g;this.x2=c;this.y2=b}b.fromWH=function(a,g,c,e){return new b(a,g,a+c,g+e)};b.fromRoom=function(a){return new b(a.getLeft(),a.getTop(),a.getRight(),a.getBottom())};b.prototype.center=function(){return[this.x1+(this.x2-this.x1)/2,this.y1+(this.y2-this.y1)/2]};b.prototype.containsXY=function(a,g){return a>=this.x1&&a<this.x2&&g>=this.y1&&g<this.y2};b.prototype.area=function(){return Math.abs(this.x2-
this.x1)*Math.abs(this.y2-this.y1)};b.prototype.width=function(){return Math.abs(this.x2-this.x1)+1};b.prototype.height=function(){return Math.abs(this.y2-this.y1)+1};return b}();window.Rect=F;window.isRGB=function(b){return 3===b.length&&"number"===typeof b[0]&&"number"===typeof b[1]&&"number"===typeof b[2]};window.clampColor=function(b){var a,g,c;c=[];for(a=g=0;2>=g;a=++g)c.push(ROT.Color._clamp(b[a]));return c};window.queryString=function(b){b=b.replace(/[*+?^$.\[\]{}()|\\\/]/g,"\\$&");return(b=
location.search.match(RegExp("[?&]"+b+"=([^&]+)(&|$)")))&&decodeURIComponent(b[1].replace(/\+/g," "))};window.queryInt=function(b){b=queryString(b);if(null!=b&&(b=parseInt(b,10),!isNaN(b)))return b};window.htmlEntities=function(b){return String(b).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")};y={cardinals:{up:[0,-1],down:[0,1],right:[1,0],left:[-1,0]},add:function(b,a){return[b[0]+a[0],b[1]+a[1]]},subtract:function(b,a){return[b[0]-a[0],b[1]-a[1]]},length:function(b){return Math.sqrt(b[0]*
b[0]+b[1]*b[1])},length2:function(b){return b[0]*b[0]+b[1]*b[1]},projectOn:function(b,a){var g;g=(b[0]*a[0]+b[1]*a[1])/(a[0]*a[0]+a[1]*a[1]);return[g*a[0],g*a[1]]},closestCardinal:function(b){var a,g,c,e,d,f;c=0;f=y.cardinals;for(e in f)a=f[e],a=y.projectOn(b,a),d=y.length2(a),d>c&&(g=a,c=d);return y.normalized(g)},normalized:function(b){var a;a=y.length(b);return[b[0]/a,b[1]/a]}};window.vector=y;window.extend=function(b,a){var g,c;for(g in a)c=a[g],b[g]=c;return b};window.funcOrString=function(){var b,
a;a=arguments[0];b=2<=arguments.length?ia.call(arguments,1):[];return"string"===typeof a?a:a.apply(null,b)};window.statusColor=function(b,a){return'<span style="color: %s;">%s</span>'.format(b,a)};window.range=function(b,a,g){b=Math.min(b)-g;a=Math.max(a)+g;return[b,a]};t=ROT.DIRS["4"];window.DIRS={UP:t[0],RIGHT:t[1],DOWN:t[2],LEFT:t[3]};window.DIRNAME=function(b){var a,g,c;for(c in DIRS)if(g=DIRS[c],a=g[0],g=g[1],b[0]===a&&b[1]===g)return c};M={" ":"____","\u2574":"r___","\u2578":"b___","\u2575":"_r__",
"\u2579":"_b__","\u2576":"__r_","\u257a":"__b_","\u2577":"___r","\u257b":"___b","\u2518":"rr__","\u251b":"bb__","\u2519":"br__","\u251a":"rb__","\u2500":"r_r_","\u2501":"b_b_","\u257e":"b_r_","\u257c":"r_b_","\u2510":"r__r","\u2513":"b__b","\u2511":"b__r","\u2512":"r__b","\u2514":"_rr_","\u2517":"_bb_","\u2516":"_br_","\u2515":"_rb_","\u2502":"_r_r","\u2503":"_b_b","\u257f":"_b_r","\u257d":"_r_b","\u250c":"__rr","\u250f":"__bb","\u250d":"__br","\u250e":"__rb","\u2534":"rrr_","\u253b":"bbb_","\u2535":"brr_",
"\u2538":"rbr_","\u2536":"rrb_","\u253a":"rbb_","\u2537":"brb_","\u2539":"bbr_","\u2524":"rr_r","\u252b":"bb_b","\u2525":"br_r","\u2526":"rb_r","\u2527":"rr_b","\u2528":"rb_b","\u252a":"br_b","\u2529":"bb_r","\u252c":"r_rr","\u2533":"b_bb","\u252d":"b_rr","\u252e":"r_br","\u2530":"r_rb","\u2532":"r_bb","\u2531":"b_rb","\u252f":"b_br","\u251c":"_rrr","\u2523":"_bbb","\u251e":"_brr","\u251d":"_rbr","\u251f":"_rrb","\u2522":"_rbb","\u2520":"_brb","\u2521":"_bbr","\u253c":"rrrr","\u254b":"bbbb","\u253d":"brrr",
"\u2540":"rbrr","\u253e":"rrbr","\u2541":"rrrb","\u254a":"rbbb","\u2548":"brbb","\u2549":"bbrb","\u2547":"bbbr","\u2542":"rbrb","\u253f":"brbr","\u2543":"bbrr","\u2544":"rbbr","\u2546":"rrbb","\u2545":"brrb","\u2550":"d_d_","\u2551":"_d_d","\u255d":"dd__","\u255a":"_dd_","\u2554":"__dd","\u2557":"d__d","\u255c":"rd__","\u2558":"_rd_","\u2553":"__rd","\u2555":"d__r","\u255b":"dr__","\u2559":"_dr_","\u2552":"__dr","\u2556":"r__d","\u2569":"ddd_","\u2560":"_ddd","\u2566":"d_dd","\u2563":"dd_d","\u2568":"rdr_",
"\u255e":"_rdr","\u2565":"r_rd","\u2561":"dr_r","\u2567":"drd_","\u255f":"_drd","\u2564":"d_dr","\u2562":"rd_d","\u256c":"dddd","\u256a":"drdr","\u256b":"rdrd"};t={};for(h in M)J=M[h],J=J.substr(1)+J.substr(0,1),assert(void 0===t[J]),t[J]=h;extend(t,{d___:"\u2551",_d__:"\u2550",__d_:"\u2551",___d:"\u2550"});window.BoxDrawing={symbols:M,symbolLookups:t,mirrorPlanes:{"\u2550":[DIRS.UP,DIRS.DOWN],"\u2551":[DIRS.LEFT,DIRS.RIGHT]}};window.constants={lightPasses:2,playerSightRadius:20,playerSpeed:100,hahaSpeedMultipler:2,
sprintMeleeMultiplier:2,sprintDistance:3,sprintStepBreathCost:10,meleeBreathCost:6,breathRecoveryStep:1,idleStatusChance:0.0010,selfEsteemColor:"#0000aa",imaginationColor:"#880055",mirrorImaginationCost:10};t=function(b){b.damage({sentence:"You glance at yourself in the mirror. %s".format(statusColor(constants.selfEsteemColor,"(%s self-esteem)".format(statusColor("red","-5")))),amount:5});return!1};K={floor:{character:"\u00b7",fg:["#666","#444","#555"],reflectivity:0.3,lightPasses:!0,blocksMovement:!1},
plywood:{reflectivity:0.1,character:"#",bg:["#965922","#a66a22","#8b4a14","#af6e2a"],fg:"#2d0a04",bump:"The plywood is firm and unyielding."},rightmirror:{reflectivity:0.1,character:"|",bumpFunc:t},leftmirror:{reflectivity:0.1,character:"|",bumpFunc:t},upmirror:{reflectivity:0.1,character:"\u2550",bumpFunc:t},downmirror:{reflectivity:0.1,character:"\u2550",bumpFunc:t},fourmirror:{reflectivity:0.1,character:"\u00a9",bumpFunc:t}};t=function(b){var a,g,c,e;e=[];g=0;for(c=b.length;g<c;g++)a=b[g],e.push(ROT.Color.fromString(a));
return e};for(I in K)q=K[I],q.name=I,null!=q.bg&&(q.bg=t(q.bg)),null!=q.fg&&("string"===typeof q.fg&&(q.fg=[q.fg]),q.fg=t(q.fg));fa=function(b){var a,g,c;a=b.bump;if(null!=a)return"string"===typeof a&&(c=function(){var c,b,f,k;f=a.split("\n");k=[];c=0;for(b=f.length;c<b;c++)g=f[c],k.push(g.trim());return k}(),c=function(){var a,b,f;if(0<g.length){f=[];a=0;for(b=c.length;a<b;a++)g=c[a],f.push(g);return f}}(),b.bump=c,a=b.bump),assert("object"===typeof a&&a.length),a.random()};window.cells=K;window.getBumpMessage=
fa;I="up up_right right down_right down down_left left up_left".split(" ");r=t=0;for(M=I.length;t<M;r=++t)C=I[r],I[C]=r;O=function(b){return Math.ceil(3*Math.pow(1.6,b))-3};ra=function(b){return 100+10*b};qa=function(b){return 100+20*b};ga=["You yawn nervously.","You cringe as loud recorded laughter booms from a hidden speaker.","There's something sharp in your shoe."];t={up:"up",page_up:"up_right",right:"right",page_down:"down_right",down:"down",end:"down_left",left:"left",home:"up_left",h:"left",
j:"down",k:"up",l:"right",y:"up_left",u:"up_right",b:"down_left",n:"down_right",w:"up",a:"left",s:"down",d:"right",i:"show_inventory"};S={};for(E in t)H=t[E],h="VK_"+E.toUpperCase(),assert(h,"unknown key "+E),D=ROT[h],null!=(z=I[H])?S[D]=z:S[D]=H;R=1;ma=function(){function b(a){for(h in a)J=a[h],this[h]=J}b.prototype.add=function(a){this.value=Math.min(this.max||0,this.value+a);0>this.value&&(this.value=0);return this.value};b.prototype.fill=function(){return this.value=this.max};b.prototype.trySubtract=
function(a){if(this.value>=a)return this.value-=a,!0};return b}();z=function(b){function a(a,c,b){this.level=a;this._x=c;this._y=b;assert(this.level);assert("number"===typeof this._x&&!isNaN(this._x));assert("number"===typeof this._y&&!isNaN(this._x));this.guid=R;R+=1;this.level.addEntity(this,this._x,this._y)}x(a,b);a.prototype.charFunc=function(a,c){return this.character};a.prototype.triggerEffect=function(a,c){null==this.effect&&(this.effect={});return this.effect[a]=c};a.prototype.damage=function(a){var c,
b;c=a.amount;b=a.sentence;null==b&&(b=a.from,a=a.verb||"damaged",b="%s %s %s.".format(b.statusDesc(),a,this.statusDesc()),b=b[0].toUpperCase()+b.substr(1));this.level.addStatus(b);0===this.health.add(-c)&&this.die();return this.triggerEffect("damage",c)};a.prototype.die=function(){this._dead=!0;this.level.removeEntity(this);this.publish("dead");return this.unsubscribeAll()};a.prototype.makeMeter=function(a,c){null==c.value&&(c.value=c.max);null==this._meters&&(this._meters={});return this._meters[a]=
new ma(c)};a.prototype.statusDesc=function(){return null!=this.legendDesc?this.needsThe?"the "+this.legendDesc:this.legendDesc:this.constructor.name};a.prototype.moveToLevel=function(a,c,b){assert(a!==this.level);this.level.removeEntity(this);this.level=a;this._x=c;this._y=b;return this.level.addEntity(this,c,b,{movingLevels:!0})};a.prototype.getSpeed=function(){return constants.playerSpeed};a.prototype.getX=function(){return this._x};a.prototype.getY=function(){return this._y};a.prototype.getKey=
function(){return""+this._x+","+this._y};a.prototype.position=function(){return[this._x,this._y]};a.prototype.bump=function(){};a.prototype.afterBump=function(){};a.prototype.setPosition=function(a,c){this._x=a;return this._y=c};return a}(function(){function b(){}b.prototype.publish=function(){var a,g,c,b,d,f;g=arguments[0];a=2<=arguments.length?ia.call(arguments,1):[];if(c=this._subscribers)if(null!=(c=c[g])){f=[];b=0;for(d=c.length;b<d;b++)g=c[b],f.push(g.apply(null,a));return f}};b.prototype.subscribe=
function(a,g){var c;if(!(c=this._subscribers[a]))c=this._subscribers[a]=[];return c.push(g)};b.prototype.unsubscribeAll=function(){return delete this._subscribers};return b}());window.Entity=z;T=function(b){var a,g;assert(b.func);for(a in b)g=b[a],"func"!==a&&(b.func[a]=g);b.func._useFunc=!0;return b.func};P=function(b){function a(){a.__super__.constructor.apply(this,arguments);this.close()}x(a,b);a.prototype.blocksPathFinding=!1;a.prototype.blocksLight=!0;a.prototype.seeInFog=!0;a.prototype.bg="#6e2311";
a.prototype.close=function(){return this.level.closedDoors[this.getKey()]=!0};a.prototype.bump=function(a){return delete this.level.closedDoors[this.getKey()]};a.prototype.hideFromLegend=!0;a.prototype.character="+";return a}(z);window.Door=P;E=function(b){function a(){return a.__super__.constructor.apply(this,arguments)}x(a,b);a.prototype.bump=function(a){return"function"===typeof a.pickup?a.pickup(this):void 0};return a}(function(b){function a(){return a.__super__.constructor.apply(this,arguments)}
x(a,b);a.prototype.useFuncs=function(){var a,c,b;b=[];for(a in this)null!=(c=this[a])&&c._useFunc&&b.push(this[a]);return b};a.prototype.blocksPathFinding=!1;a.prototype.seeInFog=!0;a.prototype.inventoryDesc=function(){return""};a.prototype.drop=T({label:"drop",func:function(a){return a.drop(this)}});return a}(z));W=function(b){function a(){return a.__super__.constructor.apply(this,arguments)}x(a,b);a.prototype.itemSort="food";a.prototype.statusDesc=function(){return"food"};a.prototype.legendDesc=
"Food";a.prototype.inventoryDesc=function(){return"Some food. Boosts your self-esteem."};a.prototype.character="%";a.prototype.color="red";a.prototype.eat=T({label:"eat",func:function(a){a.entity.eatFood(this);return a.remove(this)}});return a}(E);window.Food=W;da=function(b){function a(){a.__super__.constructor.apply(this,arguments);this.imaginationValue=Math.floor(ROT.RNG.getNormal(20,5))}x(a,b);a.prototype.itemSort="whelk";a.prototype.legendDesc="Whelk Shell";a.prototype.statusDesc=function(){return"whelk shell"};
a.prototype.character="W";a.prototype.inventoryDesc=function(){return"A sprial shell, the kind you put up to your ear to hear the ocean."};a.prototype.listen=T({label:"listen",func:function(a){var c,b;c=a.entity;b="You place the shell to your ear, and hear the ocean. "+statusColor(constants.imaginationColor,"(+%s imagination)".format(this.imaginationValue));c.level.addStatus(b);c.imagination.add(this.imaginationValue);return a.remove(this)}});return a}(E);window.WhelkShell=da;E=function(b){function a(){return a.__super__.constructor.apply(this,
arguments)}x(a,b);a.prototype.color="yellow";a.prototype.seeInFog=!0;a.prototype.afterBump=function(a,c){if(!(null!=c&&c.movingLevels))return"function"===typeof a.climbStairs?a.climbStairs(this):void 0};return a}(z);V=function(b){function a(){return a.__super__.constructor.apply(this,arguments)}x(a,b);a.prototype.character=">";a.prototype.delta=1;a.prototype.legendDesc="Stairs Down";return a}(E);ca=function(b){function a(){return a.__super__.constructor.apply(this,arguments)}x(a,b);a.prototype.character=
"<";a.prototype.delta=-1;a.prototype.legendDesc="Stairs Up";return a}(E);window.Stairs=E;window.DownStairs=V;window.UpStairs=ca;ka=function(){function b(a){this.entity=a;this.items=[]}b.prototype.remove=function(a){return this.items.remove(a)};b.prototype.drop=function(a){var g,c;this.items.remove(a);this.entity.level.addStatus("You dropped the %s.".format(a.statusDesc()));c=[this.entity.getX(),this.entity.getY()];g=c[0];c=c[1];a.setPosition(g,c);return this.entity.level.addEntity(a,g,c,{skipBump:!0})};
b.prototype.pickup=function(a){this.entity.level.removeEntity(a);return this.items.push(a)};return b}();ba=function(b){function a(){this.inventory=new ka(this);this.light={color:[200,200,200]};this.health=this.makeMeter("health",{max:ra(1)});this.breath=this.makeMeter("breath",{max:qa(1)});this.imagination=this.makeMeter("imagination",{value:20,max:100});this.xp=0;this.xplevel=1;this._updateXP();a.__super__.constructor.apply(this,arguments)}x(a,b);a.prototype.seesMirrors=!0;a.prototype.group="players";
a.prototype.toString=function(){return"<Player>"};a.prototype.color="#ff0";a.prototype.statusDesc=function(){return"you"};a.prototype.character="@";a.prototype.legendDesc="You";a.prototype.legendProps=[{type:"bar",meter:"health",label:"Self-esteem",color:constants.selfEsteemColor},{type:"bar",meter:"breath",label:"Breath",color:"#667700"},{type:"bar",meter:"imagination",label:"Imagination",color:constants.imaginationColor},{type:"bar",meter:"xpMeter",label:function(a){return"Level "+a.xplevel},color:"#006633"}];
a.prototype.awardXp=function(a){if("number"!==typeof a.xp)console.log("ERROR: expected info.xp to be a number, got "+typeof a.xp);else return this.xp+=a.xp,this._updateXP()};a.prototype._updateXP=function(){var a,c,b;a=O(this.xplevel-1);c=O(this.xplevel);for(b=this.xplevel;this.xp>=c;)this.xplevel+=1,a=O(this.xplevel-1),c=O(this.xplevel);this.xplevel>b&&this.didLevelUp();return this.xpMeter=this.makeMeter("xp",{value:this.xp-a,max:c-a})};a.prototype.didLevelUp=function(){this.level.addStatus("You're now at level "+
this.xplevel+".");return this.breath.fill()};a.prototype.die=function(){this.level.addStatus("You died.");this.level.lock();return a.__super__.die.apply(this,arguments)};a.prototype.eatFood=function(a){this.health.add(35);return this.level.addStatus("You ate the food. (+35 self-esteem)")};a.prototype.pickup=function(a){this.inventory.pickup(a);return this.level.addStatus("You picked up the %s.".format(a.statusDesc()))};a.prototype.climbStairs=function(a){var c;c=this.level.allEntities();assert(-1!==
c.indexOf(this));this.level.switchLevel(a.delta);return 1===a.delta?this.level.addStatus("You tiptoe down the stairs. They creak anyways."):this.level.addStatus("You climb the stairs.")};a.prototype.act=function(){this.level.game.turn+=1;this.level.lock();return window.addEventListener("keydown",this)};a.prototype.handleEvent=function(a){var c,b=this;c=a.keyCode;if(!a.altKey&&(H=191===c&&a.shiftKey?"show_help":S[c],null!=H)){console.log(H);a.preventDefault();if(c=this["on_"+H])return window.removeEventListener("keydown",
this),c.call(this,function(a){return a?b.level.unlock():window.addEventListener("keydown",b)});C=ROT.DIRS[8][H];a.shiftKey?this.trySprint(C[0],C[1]):(a=this._x+C[0],c=this._y+C[1],this.tryMoveTo(a,c));window.removeEventListener("keydown",this);return this.level.unlock()}};a.prototype.on_show_inventory=function(a){return showInventory(this.inventory,a)};a.prototype.on_show_help=function(a){return showHelp(a)};a.prototype.on_nextLevel=function(a){this.level.switchLevel(1);return a(!0)};a.prototype.on_prevLevel=
function(a){1<this.level.depth&&this.level.switchLevel(-1);return a(!0)};a.prototype.melee=function(a){var c;c=6;"undefined"!==typeof opts&&null!==opts&&opts.sprinting&&(c*=constants.sprintMeleeMultiplier);return this.breath.trySubtract(constants.meleeBreathCost)?a.damage({amount:c,from:this,verb:"punched"}):this.level.addStatus("You try to hit %s, but you're wheezing.".format(a.statusDesc()))};a.prototype.tryMoveTo=function(a,c,b){var d,f,k,m;d=this.level.canMoveTo(a,c);if(d.canMove){if((d=this.level.entitiesAtCell(a,
c)).length){k=0;for(m=d.length;k<m;k++){f=d[k];if(f.hostile){this.melee(f,b);return}if(("function"===typeof f.preBump?f.preBump(this,b):void 0)===BUMP_CANCEL_MOVE)return}}this.level.moveEntity(this,a,c);this.breath.add(constants.breathRecoveryStep);ROT.RNG.getUniform()<constants.idleStatusChance&&this.showIdleStatus();return!0}a=!1;null!=d.bumpFunc&&!1===d.bumpFunc(this)&&(a=!0);!a&&null!=d.bump&&this.level.addStatus(d.bump)};a.prototype.showIdleStatus=function(){if(ga.length)return this.level.addStatus(ga.removeRandom())};
a.prototype.trySprint=function(a,c){var b,d,f,k,m,p,h;p=[a*constants.sprintDistance,c*constants.sprintDistance];m=p[0];p=p[1];b=!1;for(h=[];0!==m||0!==p;){if(!this.breath.trySubtract(constants.sprintStepBreathCost)){b||this.level.addStatus("You try to sprint, but you're out of breath.");break}d=[Math.sign(m),Math.sign(p)];b=d[0];d=d[1];k=[this._x+b,this._y+d];f=k[0];k=k[1];m+=-b;p+=-d;if(!this.tryMoveTo(f,k,{sprinting:!0}))break;h.push(b=!0)}return h};a.prototype._draw=function(){return{character:"@",
color:"#ff0"}};return a}(z);window.Player=ba;Y=function(b){function a(b,c,e,d,f){this.velocity=d;this.sourceEntity=f;this.origin=[c,e];a.__super__.constructor.apply(this,arguments)}x(a,b);a.prototype.character="*";a.prototype.getSpeed=function(){return constants.playerSpeed*constants.hahaSpeedMultipler};a.prototype.drawOpts=function(){return{jiggle:[4*ROT.RNG.getUniform()-2,4*ROT.RNG.getUniform()-2]}};a.prototype.damageOpts=function(){return{verb:"laughed at"}};a.prototype.charFunc=function(a,c){return 0===
(a+c+this.level.game.turn)%2?"H":"A"};return a}(function(b){function a(){return a.__super__.constructor.apply(this,arguments)}x(a,b);a.prototype.blocksPathFinding=!1;a.prototype.seeInFog=!0;a.prototype.hideFromLegend=!0;a.prototype.damageOpts=function(){return{}};a.prototype.bump=function(a){var c;if("players"===a.group&&a.damage)return c=extend({amount:3,from:this.sourceEntity||this},this.damageOpts()),a.damage(c),this.die()};a.prototype.act=function(){var a;a=y.add(this.position(),this.velocity);
this.level.moveEntity(this,a[0],a[1]);if(!this.level.canMoveTo(this._x,this._y).canMove)return this.die()};return a}(z));ja=function(b){function a(){return a.__super__.constructor.apply(this,arguments)}x(a,b);a.prototype.attackStatus=function(){return["laughing maniacally","giggling","chuckling"].random()};a.prototype.fire=function(a){var c,b,d,f,k;b=this.entity.position();k=[];d=1;for(f=constants.hahaSpeedMultipler+1;1<=f?d<=f:d>=f;1<=f?++d:--d){b=y.add(a,b);for(var m=void 0,p=void 0,h=void 0,v=
void 0,h=this.entity.level.entitiesAtCell(b[0],b[1]),v=[],m=0,p=h.length;m<p;m++)c=h[m],c instanceof Y&&v.push(c);c=v;0===c.length?k.push(new Y(this.entity.level,b[0],b[1],a,this.entity)):k.push(void 0)}return k};a.prototype.shouldAttack=function(a){var b;b=a.entity;null==a.closestCardinalTo&&(a.closestCardinalTo=y.closestCardinal(a.vectorTo));null==a.lengthTo&&(a.lengthTo=y.length(a.vectorTo));if(3<a.lengthTo&&b.getX()===this.entity.getX()||b.getY()===this.entity.getY())return this.fire(a.closestCardinalTo),
!0};return a}(function(){return function(b){this.entity=b}}());aa=function(b){function a(){return a.__super__.constructor.apply(this,arguments)}x(a,b);a.prototype.character="\u2639";a.prototype.legendDesc="Man on Stool";a.prototype.preBump=function(a){if("players"===a.group)return a.level.addStatus("What are you doing in here alone?"),BUMP_CANCEL_MOVE};return a}(z);window.NPC=aa;$=function(b){function a(){a.__super__.constructor.apply(this,arguments);this.attacks=[new ja(this)];this.health=this.makeMeter("health",
{max:20})}x(a,b);a.prototype.needsThe=!0;a.prototype.hostile=!0;a.prototype.character="C";a.prototype.sightRadius=15;a.prototype.legendDesc="Evil Clown";a.prototype.legendProps=[{type:"bar",meter:"health",label:"Health"}];a.prototype.xpValue=function(){return 1};a.prototype.die=function(){this.level.awardXp({xp:this.xpValue()});return a.__super__.die.apply(this,arguments)};a.prototype.attacks={scratch:{verb:"scratches",damage:3}};a.prototype.act=function(){var a,b,e,d,f,k,m;e=this.position();m=this.visibleEntities("players");
f=0;for(k=m.length;f<k;f++){a=m[f];this.lastSeenPos=a.position();d=y.subtract(this.lastSeenPos,e);b=y.length(d);if(2>b){this.attack(a);return}if(this.chooseAttack({entity:a,vectorTo:d}))return}if(null!=this.lastSeenPos)return this.state="Hunting",this.headTowards(this.lastSeenPos[0],this.lastSeenPos[1])};a.prototype.chooseAttack=function(a){var b,e,d,f;f=this.attacks;e=0;for(d=f.length;e<d;e++)if(b=f[e],b.shouldAttack(a)){if(a="function"===typeof b.attackStatus?b.attackStatus():void 0)this.state=
a;return!0}};a.prototype.attack=function(a){if(null!=a&&a.damage)return a.damage({amount:3,from:this,verb:["smacked","punched"].random()})};a.prototype.headTowards=function(a,b){var e,d,f=this;e=new ROT.Path.AStar(a,b,function(a,b){return f.level.canMoveTo(a,b,{entities:!0,self:f}).canMove},{topology:8});d=[];e.compute(this._x,this._y,function(a,b){return d.push([a,b])});d.shift();if(d.length)return this.level.moveEntity(this,d[0][0],d[0][1])};a.prototype.visibleEntities=function(a){var b,e,d=this;
null==this.fov&&(this.fov=this.level.createFOV());b=null!=a?function(b){return b.group===a}:function(a){return!0};e=[];this.fov.compute(this._x,this._y,this.sightRadius,function(a,g,m,p){var h;if(p)return m=function(){var d,e,m,l;m=this.level.entitiesAtCell(a,g);l=[];d=0;for(e=m.length;d<e;d++)h=m[d],b(h)&&l.push(h);return l}.call(d),e=e.concat(m)});return e};return a}(z);window.Monster=$;G=function(b,a){return b+","+a};window.BUMP_CANCEL_MOVE={};window.COORDS=function(b){var a;a=b.split(",");b=parseInt(a[0]);
a=parseInt(a[1]);return[b,a]};Z=function(){function b(a,b){this.game=a;null==b&&(b={});this.cells={};this.closedDoors={};this.bgs={};this.fgs={};this.chars={};this.debug={};this.fog={};this.cellsByName={};this.entities={};this.mirrorSeers=[];this.addActor=b.addActor;this.removeActor=b.removeActor;this.depth=b.depth;this.generate(b);this.ambientLight=[0,0,0];this.display=this.game.display}b.prototype.canMoveTo=function(a,b,c){null==c&&(c={});h=G(a,b);q=this.cells[G(a,b)];if(null==q)return{canMove:!1};
if(c.entities){var e,d,f;d=this.entitiesAtCell(a,b);f=[];b=0;for(e=d.length;b<e;b++)a=d[b],!1!==a.blocksPathFinding&&f.push(a);if(1===f.length&&f[0]!==c.self||1<f.length)return{canMove:!1}}return!1===q.blocksMovement?{canMove:!0}:{canMove:!1,bump:fa(q),bumpFunc:q.bumpFunc}};b.prototype.allEntities=function(){var a,b,c;a=[];c=this.entities;for(h in c)b=c[h],a=a.concat(b);return a};b.prototype.entitiesAtCell=function(a,b){return(this.entities[G(a,b)]||[]).slice()};b.prototype.hostilesAtCell=function(a,
b){var c,e,d,f,k;f=this.entitiesAtCell(a,b);k=[];e=0;for(d=f.length;e<d;e++)c=f[e],c.hostile&&k.push(c);return k};b.prototype.switchLevel=function(a){return this.game.switchLevel(a)};b.prototype.findFreeCell=function(a){var b,c,e,d,f;b=null!=a?a:{};a=b.type;c=b.room;null==a&&(a="floor");assert("string"===typeof a);b=this.cellsByName[a];assert(b.length);for(c=null!=c?F.fromRoom(c):void 0;;)if(h=b.random(),d=COORDS(h),e=d[0],d=d[1],null==c||c.containsXY(e,d))if(assert(this.cells[h]===K[a]),!(null!=
(f=this.entities[h])&&f.length))return[e,d]};b.prototype.lock=function(){return this.game.lock()};b.prototype.unlock=function(){return this.game.unlock()};b.prototype.addStatus=function(a){return this.game.addStatus(a)};b.prototype.setCell=function(a,b,c){q=K[c];assert(q,"unknown cell type '%s'".format(c.toString()));h=a+","+b;a=this.cells[h];null!=a&&(delete this.fgs[h],delete this.bgs[h],a=this.cellsByName[a.name],r=a.indexOf(h),-1!==r&&a.splice(r,1));this.cells[h]=q;null!=q.bg&&(this.bgs[h]=q.bg.random());
null!=q.fg&&(this.fgs[h]=q.fg.random());(a=this.cellsByName[c])||(a=this.cellsByName[c]=[]);return a.push(h)};b.prototype.generate=function(a){var b;a.numMonsters=Math.floor(2.5*this.depth);a.numFood=Math.floor(2.4*this.depth);a.numShells=Math.floor(this.depth);b=this._generateDigger();this._paint();this._placeEntities(b,a);return this.recalcFov()};b.prototype._generateDigger=function(a){var b,c,e,d,f,k,m,h,B,v,s,w,l,u,q,n,A=this;this.width=Math.floor(50+2.9*(this.depth-1));this.height=Math.floor(20+
2.7*(this.depth-1));this.roomDugPercentage=Math.min(1,0.1+0.1*this.depth);this.roomRange=[[4,Math.floor(12+this.depth/3.2)],[3,Math.floor(10+this.depth/3.2)]];e={roomWidth:this.roomRange[0],roomHeight:this.roomRange[1],timeLimit:Infinity};b=ROT.Map.Uniform;e.roomDugPercentage=this.roomDugPercentage;b=new b(this.width,this.height,e);b.create(function(a,b,c){if(0===c)return A.setCell(a,b,"floor")});e=b.getRooms();this.roomInfos=h=[];c=!1;f=l=0;for(u=e.length;l<u;f=++l)m=e[f],f=F.fromRoom(m),f={room:m,
rect:f,area:f.area()},h.push(f),80<f.area&&!c&&(window.mazeRoom=f,this._generateRoomMaze(f,a),c=!0);f=a=0;for(c=Math.floor(4*ROT.RNG.getUniform());0<=c?a<=c:a>=c;f=0<=c?++a:--a){f=e.random();k=F.fromRoom(f);B=k.x1-1;v=k.x2+1;s=k.y1-1;w=k.y2+1;h=[function(){var a,b,c,d,g;g=[];a=b=c=k.x1;for(d=k.x2;c<=d?b<=d:b>=d;a=c<=d?++b:--b)null==A.cells[a+","+s]&&null==A.cells[a+","+(s-1)]?g.push(A.setCell(a,s,"fourmirror")):g.push(void 0);return g},function(){var a,b,c,d,g;g=[];a=b=c=k.x1;for(d=k.x2;c<=d?b<=d:
b>=d;a=c<=d?++b:--b)null==A.cells[a+","+w]&&null==A.cells[a+","+(w+1)]?g.push(A.setCell(a,w,"fourmirror")):g.push(void 0);return g},function(){var a,b,c,d,g;g=[];a=b=c=k.y1;for(d=k.y2;c<=d?b<=d:b>=d;a=c<=d?++b:--b)null==A.cells[B+","+a]&&null==A.cells[B-1+","+a]?g.push(A.setCell(B,a,"fourmirror")):g.push(void 0);return g},function(){var a,b,c,d,g;g=[];a=b=c=k.y1;for(d=k.y2;c<=d?b<=d:b>=d;a=c<=d?++b:--b)null==A.cells[v+","+a]&&null==A.cells[v+1+","+a]?g.push(A.setCell(v,a,"fourmirror")):g.push(void 0);
return g}];h=h.randomize();f=l=0;for(u=Math.floor(ROT.RNG.getUniform()*h.length);0<=u?l<=u:l>=u;f=0<=u?++l:--l)h[f]()}f=h=0;for(m=this.height;0<=m?h<=m:h>=m;f=0<=m?++h:--h){a=l=0;for(q=this.width;0<=q?l<=q:l>=q;a=0<=q?++l:--l)if(null==this.cells[a+","+f]){n=ROT.DIRS["8"];u=0;for(c=n.length;u<c;u++)if(d=n[u],e=d[0],d=d[1],this.cells[a+e+","+(f+d)]===K.floor){this.setCell(a,f,"plywood");break}}}return b};b.prototype.getNeighbors=function(a,b){var c,e,d,f,k,m;d=[];m=ROT.DIRS["4"];C=f=0;for(k=m.length;f<
k;C=++f)e=m[C],c=e[0],e=e[1],d.push(this.cells[a+c+","+(b+e)]);return d};b.prototype._paint=function(){var a,b,c,e,d,f,k,m;c={fourmirror:"d"};k=this.cellsByName.fourmirror;m=[];d=0;for(f=k.length;d<f;d++){h=k[d];e=COORDS(h);b=e[0];e=e[1];q=this.cells[h];e=this.getNeighbors(b,e);for(var p=void 0,B=void 0,v=void 0,v=[],p=0,B=e.length;p<B;p++)b=e[p],v.push(c[null!=b?b.name:void 0]||"_");b=v.join("");null!=(a=BoxDrawing.symbolLookups[b])?m.push(this.chars[h]=a):m.push(void 0)}return m};b.prototype._generateRoomMaze=
function(a,b){var c,e=this;c=a.rect;(new ROT.Map.IceyMaze(c.width()+1,c.height()+1,0)).create(function(a,b,g){a+=c.x1;b+=c.y1;if(0!==g)return e.setCell(a,b,"plywood")});return a.room.getDoors(function(a,b){var c,g,h,B,v;v=[];c=g=h=b-1;for(B=b+1;h<=B?g<=B:g>=B;c=h<=B?++g:--g)v.push(function(){var b,g,e,f;f=[];r=b=g=a-1;for(e=a+1;g<=e?b<=e:b>=e;r=g<=e?++b:--b)f.push(this.setCell(r,c,"floor"));return f}.call(e));return v})};b.prototype._generateMaze=function(a,b){var c=this;(new ROT.Map.EllerMaze(a,
b)).create(function(a,b,g){return 0===g?c.setCell(a,b,"floor"):c.setCell(a,b,"fourmirror")});return{getRooms:function(){return[new ROT.Map.Feature.Room(0,0,a,b)]}}};b.prototype._generateRoom=function(a,b){var c,e,d,f,k,h;c=e=0;for(d=a-1;0<=d?e<=d:e>=d;c=0<=d?++e:--e)this.setCell(c,0,"plywood"),this.setCell(c,b-1,"plywood");e=c=0;for(d=b-1;0<=d?c<=d:c>=d;e=0<=d?++c:--c)this.setCell(0,e,"plywood"),this.setCell(a-1,e,"plywood");e=d=1;for(k=b-2;1<=k?d<=k:d>=k;e=1<=k?++d:--d){c=f=1;for(h=a-2;1<=h?f<=h:
f>=h;c=1<=h?++f:--f)this.setCell(c,e,"floor")}return{getRooms:function(){return[new ROT.Map.Feature.Room(0,0,a,b)]}}};b.prototype._placeEntities=function(a,b){var c,e,d,f,k,m,p,B,v,s,w,l,u,n,t=this;w=a.getRooms();k=w.random();m=F.fromRoom(k);d=this.findFreeCell({room:k});s=d[0];l=d[1];this.downStairs=new V(this,s,l);d=function(){var a,b,c;c=[];a=0;for(b=w.length;a<b;a++)v=w[a],v!==k&&c.push(v);return c}();d.length&&d.sort(function(a,b){var c,d;c=L.distance(F.fromRoom(a).center(),m.center());d=L.distance(F.fromRoom(b).center(),
m.center());return c>=d?-1:1});d=d[0]||k;f=F.fromRoom(d);l=this.findFreeCell({room:d});s=l[0];l=l[1];b.noUpStairs?this.upStairsPosition=[s,l]:this.upStairs=new ca(this,s,l);if(1<w.length){w=w.slice();l={};u=0;for(n=w.length;u<n;u++)s=w[u],e=0,s.getDoors(function(a,b){return e+=1}),null==l[e]&&(l[e]=[]),l[e].push(s)}B=function(a,b){q=this.cells[G(a,b)];return!q||!1!==q.blocksMovement};c={};n=this.roomInfos;l=0;for(u=n.length;l<u;l++)s=n[l],s.room.getDoors(function(a,b){if(B(a-1,b)&&B(a+1,b)||B(a,b-
1)&&B(a,b+1))if(h=G(a,b),!c[h])return c[h]=!0,new P(t,a,b)});r=u=0;for(n=b.numMonsters-1;0<=n?u<=n:u>=n;r=0<=n?++u:--u){l=this.findFreeCell();s=l[0];l=l[1];if(d!==k)for(p=0;f.containsXY(s,l);)assert(100>(p+=1)),l=this.findFreeCell(),s=l[0],l=l[1];new $(this,s,l)}r=d=0;for(f=b.numFood-1;0<=f?d<=f:d>=f;r=0<=f?++d:--d)l=this.findFreeCell(),s=l[0],l=l[1],new W(this,s,l);r=d=0;for(f=b.numShells-1;0<=f?d<=f:d>=f;r=0<=f?++d:--d)l=this.findFreeCell(),s=l[0],l=l[1],new da(this,s,l);d=this.findFreeCell();s=
d[0];l=d[1];return new aa(this,s,l)};b.prototype.entryPosition=function(a){var b;return 0<a?(null!=(b=this.upStairs)?b.position():void 0)||this.upStairsPosition:this.downStairs.position()};b.prototype._lightPasses=function(a,b){var c;h=a+","+b;if(null!=(c=this.cells[h])&&c.lightPasses&&!this.closedDoors[h])return!0};b.prototype.createFOV=function(){var a=this;return new ROT.FOV.DiscreteShadowcasting(function(b,c){return a._lightPasses(b,c)},{topology:8})};b.prototype.recalcFov=function(){var a=this;
return this.fov=new ROT.FOV.PreciseShadowcasting(function(b,c){return a._lightPasses(b,c)},{topology:8})};b.prototype.calcLightData=function(){var a,b,c,e,d,f,k,m,p=this;d=new ROT.Lighting(function(a,b){var c;return(null!=(c=p.cells[a+","+b])?c.reflectivity:void 0)||0},{range:constants.playerSightRadius,passes:constants.lightPasses});d.setFOV(this.fov);m=this.entities;for(h in m){b=m[h];f=0;for(k=b.length;f<k;f++)a=b[f],(e=a.light)&&d.setLight(a.getX(),a.getY(),e.color)}c={};d.compute(function(a,
b,d){return c[a+","+b]=d});return c};b.prototype.calcVisible=function(){var a,b,c,e,d=this;this.visible={};null==this.hasBeenVisible&&(this.hasBeenVisible={});this._visibleEntities=[];e=this.mirrorSeers;b=0;for(c=e.length;b<c;b++)a=e[b],this.fov.compute(a.getX(),a.getY(),constants.playerSightRadius,function(a,b,c,g){var e,n;h=a+","+b;d.visible[a+","+b]=g;d.hasBeenVisible[a+","+b]=!0;e=d.entities[h]||[];n=[];b=0;for(g=e.length;b<g;b++)a=e[b],n.push(d._visibleEntities.push({entity:a,distance:c}));return n})};
b.prototype.visibleEntities=function(){return this._visibleEntities||[]};b.prototype.awardXp=function(a){var b,c,e,d;d=this.mirrorSeers;c=0;for(e=d.length;c<e;c++)b=d[c],b.awardXp&&b.awardXp(a)};b.prototype.addEntity=function(a,b,c,e){var d,f,k,m;null==e&&(e={});assert(a.getX()===b);assert(a.getY()===c);h=G(b,c);c=this.entities[h];null==c&&(c=this.entities[h]=[]);c.push(a);!1!==e.addActor&&a.act&&(this.addActor(a),a.seesMirrors&&this.mirrorSeers.push(a));b=!1;if(!e.skipBump){m=c.slice();f=0;for(k=
m.length;f<k;f++)d=m[f],d!==a&&(b|=a.bump(d,e)===BUMP_CANCEL_MOVE,b|=d.bump(a,e)===BUMP_CANCEL_MOVE);k=c.slice();d=0;for(f=k.length;d<f;d++)c=k[d],c!==a&&(c.afterBump(a,e),a.afterBump(c,e))}if(b)return BUMP_CANCEL_MOVE};b.prototype.moveEntity=function(a,b,c){this.removeEntity(a,{removeActor:!1});a.setPosition(b,c);return this.addEntity(a,b,c,{addActor:!1})};b.prototype.removeEntity=function(a,b){var c,e,d,f,k;null==b&&(b={});c=a.getX();e=a.getY();e=this.entities[G(c,e)];assert(e);d=void 0;r=f=0;for(k=
e.length;f<k;r=++f)if(c=e[r],c===a){d=e.splice(r,1);1===e.length&&e[0]instanceof P&&e[0].close();assert(d[0]===c&&c===a);break}assert(d);if(!1!==b.removeActor&&a.act&&(this.removeActor(a),r=this.mirrorSeers.indexOf(a),-1!==r))return this.mirrorSeers.splice(r,1)};b.prototype.wakeUpActors=function(){var a,b,c,e;e=this.allEntities();b=0;for(c=e.length;b<c;b++)a=e[b],a.act&&this.addActor(a)};b.prototype.draw=function(){var a,b,c,e,d,f,k,m,p,n,v,s,w,l,u,t,r,A,x,y,D,z,E;this.display.clear();u=this.calcLightData();
this.calcVisible();a=ROT.Color;b=ROT.Color.add;A=ROT.Color.multiply;f=this.camera.getRect();z=x=v=f.y1;for(y=f.y2;v<=y?x<=y:x>=y;z=v<=y?++x:--x){k=n=s=f.x1;for(w=f.x2;s<=w?n<=w:n>=w;k=s<=w?++n:--n)if(D=k-f.x1,r=z-f.y1,h=k+","+z,q=this.cells[h],null!=q){z=COORDS(h);k=z[0];z=z[1];e=this.fgs[h]||[255,255,255];l=u[h];d=this.fog[h]||0;l&&(c=l[0],d<c&&(d=Math.min(70,c),this.fog[h]=d));if(!l||l&&d>=(l[0]||0))l=[d,d,d];null==l&&(l=this.ambientLight);d=u[h];null!=d&&(l=clampColor(b(l,d)));c=this.entities[h];
if(null==this.visible[h]){var F=p=m=d=void 0;p=c||[];F=[];d=0;for(m=p.length;d<m;d++)c=p[d],c.seeInFog&&F.push(c);c=F}d=null;m=void 0;if(null!=c&&c.length){e=l;c=c[c.length-1];k=c.charFunc(k,z);m=c.drawOpts?c.drawOpts():void 0;if(null!=(p=c.color))"string"===typeof p&&(p=ROT.Color.fromString(p)),e=A(e,p);if(null!=(c=c.bg))"string"===typeof c&&(c=ROT.Color.fromString(c)),d=c}else e=A(e,l),k=this.chars[h]||q.character,d=this.bgs[h]||null;d&&(d=a.toRGB(A(d,l)));this.display.draw(D,r,k,a.toRGB(e),d||
null,m)}}this.debug={};assert(1===this.mirrorSeers.length);c=this.mirrorSeers[0];b=[c.getX(),c.getY()];a=b[0];f=b[1];b=this.cellsByName.fourmirror||[];A=0;for(D=b.length;A<D;A++)if(h=b[A],this.visible[h]&&(t=this.chars[h])){r=COORDS(h);u=r[0];r=r[1];n=void 0;y=BoxDrawing.mirrorPlanes[t]||[];v=0;for(x=y.length;v<x;v++)if(C=y[v],s=Math.sign(a-u),w=Math.sign(f-r),s=s&&s===C[0]?s:0,w=w&&w===C[1]?w:0,s||w){x=G(u+s,r+w);(x=this.cells[x])&&x.lightPasses&&(n=C);break}if(n&&(x=-n[0],e=-n[1],s=x,l=e,x||e))for(w=
y=v=n=0;;){n+=x;v+=e;y+=s;w+=l;d=u-y+","+(r-w);if(!this.cells[d])break;c=this.camera.getScreenKey(u-y,r-w);c=this.display._data[c];if(null==c)break;p=this.camera.getScreenCoords(u+n,r+v);m=p[0];p=p[1];if(m>=this.camera.width||p>=this.camera.height||0>m||0>p)break;c=c.slice();c[0]=m;c[1]=p;q=this.cells[this.camera.getWorldKey(k,z)];(E=this.display).draw.apply(E,c);c={};p=BoxDrawing.mirrorPlanes[this.chars[d]]||[];m=0;for(d=p.length;m<d;m++)C=p[m],c[C[0]+","+C[1]]=!0;if(0>s&&c["-1,0"]||0<s&&c["1,0"])s=
-s;if(0>l&&c["0,-1"]||0<l&&c["0,1"])l=-l}}};b.prototype.setCamera=function(a){this.camera=a};return b}();window.Level=Z;U=function(){function b(a,b,c){this.entity=a;this.width=b;this.height=c;this.getRect()}b.prototype.getScreenCoords=function(a,b){return[a-this.rect.x1,b-this.rect.y1]};b.prototype.getScreenKey=function(a,b){return a-this.rect.x1+","+(b-this.rect.y1)};b.prototype.getWorldKey=function(a,b){return a+this.rect.x1+","+(b+this.rect.y1)};b.prototype.getRect=function(){var a;a=[this.entity.getX()-
Math.floor(this.width/2),this.entity.getY()-Math.floor(this.height/2)];return this.rect=F.fromWH(a[0],a[1],this.width,this.height)};return b}();window.Camera=U;n=Zepto;N=null;ya=function(){N||(N="h e  l   p \n~ ~ ~ ~ ~ ~\n\n(general)\n\n[ ? ]     - show this help dialog\n\n[ i ]     - bring up your inventory\n[ shift ] - hold to sprint while moving\n\n\n(ambulation)\n\n            [ up \u2191 ]\n[ left \u2190 ][ down \u2193 ][ right \u2192 ]\n\n[ home \u2196 ][   page up \u2197 ]\n[  end \u2199 ][ page down \u2198 ]\n\n[ y \u2196 ][ u \u2197 ]\n  [ h \u2190 ][ j \u2193 ][ k \u2191 ][ l \u2192 ]\n[ b \u2199 ][ n \u2198 ]\n\n\n[ ESC ] - exit this dialog".replace(/[\u2196\u2191\u2197\u2190\u2199\u2193\u2198\u2192]/g,
function(b,a){return"<span class='big'>"+b+"</span>"}),N=N.replace(/[\[\]]/g,function(b){return"<span class='dim'>"+b+"</span>"}));return N};pa=function(b,a){var g;g=a.label;return"string"===typeof g?g:g(b)};sa={bar:function(b,a,g){var c,e,d,f,k;null!=(d=a.meter)?(e=b[d],k=e.value,e=e.max):(d=a.attr,k=b[a.attr],assert(null!=k,'entity %s missing expected "%s"'.format(b,a.attr)),e=b[a.maxAttr],assert(null!=e,'entity %s missing expected "%s"'.format(b,a.maxAttr)));f=100*Math.min(1,k/e);d="prop-"+d;g=
n(g).children("."+d);e=!1;g.length?(c=g.children(".bar"),d=g.children(".text")):(g=n("<div>").addClass("progress").addClass(d),c=n("<div>").addClass("bar").appendTo(g),d=n("<div>").addClass("text").appendTo(g),e=!0);d.text(pa(b,a));null!=a.color&&c.css("background",a.color);b=function(){return c.css("width",f+"%")};e&&(b(),b=void 0);return[g[0],b]}};ta=function(b){var a;for(a=[];b.childNodes.length;)a.push(b.removeChild(b.childNodes[0]));return a};xa=function(b,a){var g,c;b=n(b);if(!(g=a.state))return b.children(".entity-state").remove();
if(0===(c=b.children(".entity-state")).length)c=n("<div>").addClass("entity-state");c.appendTo(b);return c.text("(%s)".format(g))};ea=function(b){var a;a=document.createElement("span");b.color&&a.setAttribute("style","color: %s;".format(b.color));a.textContent=b.charFunc(1,1);return a};window.updateLegendNodeForEntity=function(b,a){var g,c,e,d,f;g=n(b).children(".entity-header");g.length||(g=n("<div>").addClass("entity-header").appendTo(b));ta(g[0]);g.append(ea(a));c=": %s".format(a.legendDesc||a.constructor.name);
g.append(document.createTextNode(c));b.appendChild(g[0]);if(null!=(f=a.effect)&&f.damage)a.effect.damage=0,n(b).addClass("shake"),setTimeout(function(){return n(b).removeClass("shake")},400);f=a.legendProps||[];g=0;for(c=f.length;g<c;g++)d=f[g],e=sa[d.type],e=e(a,d,b),d=e[0],e=e[1],b.appendChild(d),e&&setTimeout(e,0);return xa(b,a)};window.updateLegendNodes=function(b,a){var g,c,e,d,f,k;n(b).children("div");d={};f=0;for(k=a.length;f<k;f++)g=a[f].entity,c="entity-"+g.guid,e=document.getElementById(c)||
n("<div>").attr("id",c).addClass("legend-entry")[0],b.appendChild(e),updateLegendNodeForEntity(e,g),d[c]=!0;k=b.children;c=[];e=0;for(f=k.length;e<f;e++)g=k[e],d[g.getAttribute("id")]||c.push(g);f=[];d=0;for(e=c.length;d<e;d++)g=c[d],f.push(b.removeChild(g));return f};wa=function(b){var a,g,c,e,d,f;g={};a=[];d=0;for(f=b.length;d<f;d++)e=b[d],assert(e.itemSort),h=e.itemSort,null==g[h]&&a.push(g[h]=[]),c=g[h],c.push(e);return a};va=function(b,a){var g;b.addClass("dialog");n("#game").append(b);g=function(){var c;
c=1<=arguments.length?ia.call(arguments,0):[];window.removeEventListener("keydown");b.remove();if(a)return a.apply(null,c)};return window.addEventListener("keydown",function(a){D=a.keyCode;if(D===ROT.VK_ESCAPE)return g(),a.preventDefault()})};window.showHelp=function(b){var a;a=n("<div>").attr("id","help").addClass("dialog");a.html(ya());return va(a,b)};window.showInventory=function(b,a){var g,c,e,d,f,k,h,p,q,r;e=n("<div>").attr("id","inventory").addClass("dialog");h=65;g=wa(b.items);f={};q=0;for(r=
g.length;q<r;q++)d=g[q],k=String.fromCharCode(h).toLowerCase(),f[h]=d,n("<div>").addClass("inv-item").text("%s) ".format(k)).append(oa(d)).appendTo(e),h+=1;g.length||n("<span>").text("(Your pockets are empty.)").appendTo(e);n(e).append(n("<div>").addClass("inv-escape").text("ESC) close inventory"));n("#game").append(e);p=function(a){var d;D=a.keyCode;if(!a.altKey){if(D===ROT.VK_ESCAPE||D===ROT.VK_I)c();else if(d=f[D])window.removeEventListener("keydown",p),ua(d,b,function(a){window.addEventListener("keydown",
p);if(a)return c(!0)});else return;return a.preventDefault()}};c=function(b){window.removeEventListener("keydown",p);e.remove();return a(b)};return window.addEventListener("keydown",p)};ua=function(b,a,g){var c,e,d,f,h,m,p,q,r,s;m=b[0];d=n("<div>").attr("id","item-detail").addClass("dialog");ha(b).addClass("item-detail-header").appendTo(d);m.inventoryDesc&&n("<div>").addClass("item-detail-desc").html(m.inventoryDesc()).appendTo(d);e=n("<div>").addClass("item-actions").appendTo(d);c={};s=m.useFuncs();
p=function(b){var d,g,f;g=b.label;f=g[0];d=f.toUpperCase().charCodeAt(0);c[d]=function(){return b.call(m,a)};return n("<div>").addClass("item-action").appendTo(e).append(document.createTextNode(g.substr(0,0))).append(n("<span>").addClass("shortcut-key").text(f)).append(document.createTextNode(g.substr(1)))};q=0;for(r=s.length;q<r;q++)b=s[q],p(b);n("#game").append(d);h=function(a){var b;if(!a.altKey){D=a.keyCode;if(D===ROT.VK_ESCAPE)f();else if(b=c[D])b(),f(!0);else return;return a.preventDefault()}};
f=function(a){window.removeEventListener("keydown",h);d.remove();return g(a)};return window.addEventListener("keydown",h)};ha=function(b){var a;a=b[0];b=b.length;a=n("<span>").text(a.statusDesc());1<b&&(a.append(document.createTextNode(" ")),a.append(n("<span>").addClass("inv-quantity").text("<%s>".format(b))));return a};oa=function(b){var a,g;a=b[0];g=n("<span>");g.append(ea(a));g.append(document.createTextNode(" "));g.append(ha(b));return g};la=!1;Q=[66/255,128/255,1];na=function(){function b(a){this.node=
a;this.messages=[]}b.prototype.limit=3;b.prototype.addStatus=function(a){var b,c,e,d,f;this.messages.push({text:a,color:[255,255,255]});b=document.createElement("div");n(b).html(a);for(this.node.appendChild(b);this.node.childNodes.length>this.limit;)this.node.removeChild(this.node.childNodes[0]);this.messages.slice(-this.limit);d=this.node.childNodes;f=[];r=c=0;for(e=d.length;c<e;r=++c)b=d[r],a=null!=Q[r]?Q[r]:Q[0],f.push(b.setAttribute("style","opacity: %s;".format(a)));return f};return b}();X=function(){function b(a){this.seed=
a.seed;this.turn=0;this.displaywidth=50;this.displayheight=25;this.statusMessages=new na(document.getElementById("status"));la&&(a=n("#mapDebug"),this.debugDisplay=new ROT.Display({fontSize:12}),a.append(this.debugDisplay.getContainer()),this.debugDisplayInfo=n("<pre>"),a.append(this.debugDisplayInfo));this.display=new ROT.Display({fontFamily:"DejaVuSansMono, DejaVu Sans Mono, Monaco, Consolas, Inconsolata, monospace",fontSize:21,spacing:1.1,width:this.displaywidth,height:this.displayheight});a=this.display.getContainer();
document.getElementById("display").appendChild(a);this.engine=new ROT.Engine;this.levelDepth=0;this.levels={};this.switchLevel(1,{noUpStairs:!0});this.addStatus("You enter the funhouse.");this.addStatus("The exit slams shut behind you.");this.addStatus("Press &lt;?&gt; for help at any time.");this.engine.start()}b.prototype.url=function(){return window.location.origin+("/?seed="+this.seed)};b.prototype.switchLevel=function(a,b){var c,e,d,f=this;this.levelDepth+=a;this.level=this.levels[this.levelDepth];
this.engine.clear();null==this.level?(null==b&&(b={}),b.addActor=function(a){return f.engine.addActor(a)},b.removeActor=function(a){return f.engine.removeActor(a)},b.depth=this.levelDepth,this.level=new Z(this,b),this.levels[this.levelDepth]=this.level):this.level.wakeUpActors();if(null!=this.debugDisplay){this.debugDisplay.clear();this.debugDisplay.setOptions({width:this.level.width,height:this.level.height});d=this.level.cells;for(h in d)q=d[h],e=COORDS(h),c=e[0],e=e[1],q&&!1===q.blocksMovement&&
this.debugDisplay.DEBUG(c,e,1);this.debugDisplayInfo.text("Level is "+this.level.width+"x"+this.level.height+" at depth "+this.levelDepth+" with "+this.level.roomInfos.length+" rooms\ndugPercentage: "+this.level.roomDugPercentage+"\nroomRange: "+this.level.roomRange)}d=this.level.entryPosition(a);c=d[0];e=d[1];null==this.player?(this.player=new ba(this.level,c,e),this.camera=new U(this.player,this.displaywidth,this.displayheight)):this.player.moveToLevel(this.level,c,e);this.level.setCamera(this.camera);
return this.display.clear()};b.prototype.addStatus=function(a){return this.statusMessages.addStatus(a)};b.prototype.updateLegend=function(a){var b;b=document.getElementById("legend");return updateLegendNodes(b,a)};b.prototype.lock=function(){var a;this.level.draw();this.updateLegend(function(){var b,c,e,d;e=this.level.visibleEntities();d=[];b=0;for(c=e.length;b<c;b++)a=e[b],a.entity.hideFromLegend||d.push(a);return d}.call(this));return this.engine.lock()};b.prototype.unlock=function(){return this.engine.unlock()};
return b}();window.Game=X;Zepto(function(){var b;if(null==(b=queryInt("seed")))b=Date.now();ROT.RNG.setSeed(b);return window.game=new X({seed:b})})}).call(this);
